package golang

import (
	"strings"

	"github.com/68696c6c/capricorn_rnd/utils"
)

// File represents a leaf node in a golang project tree.
type File struct {
	*utils.File
	*imports
	PKG *Package // this is set when a File is passed to package.AddGoFile()
	// InitFunction Function    `yaml:"init_function,omitempty"`
	// Consts       []Const     `yaml:"consts,omitempty"`
	// Vars         []Var       `yaml:"vars,omitempty"`
	// TypeAliases  []Value     `yaml:"type_aliases,omitempty"`
	structs    []*Struct
	interfaces []*Interface
	// Functions    []Function  `yaml:"functions,omitempty"`
}

func NewFile(basePath, name string) *File {
	return &File{
		File:    utils.NewFile(basePath, utils.Snake(name), "go"),
		imports: newImports(),
	}
}

func (f *File) Render() string {
	var lines []string

	for _, i := range f.interfaces {
		f.imports = mergeImports(*f.imports, i.getImports())
		lines = append(lines, i.Render())
	}

	for _, s := range f.structs {
		f.imports = mergeImports(*f.imports, s.getImports())
		lines = append(lines, s.Render())
	}

	result := []string{
		`// Code generated by "gonad"; DO NOT EDIT.`,
		f.PKG.declaration,
		"",
		f.imports.Render(),
	}
	result = append(result, lines...)
	return strings.Join(result, "\n")
}

func (f *File) AddStruct(s *Struct) {
	s.Type.Package = f.PKG.GetName()
	s.Type.Import = f.PKG.GetImport()
	f.structs = append(f.structs, s)
}

func (f *File) AddInterface(i *Interface) {
	i.Type.Package = f.PKG.GetName()
	i.Type.Import = f.PKG.GetImport()
	f.interfaces = append(f.interfaces, i)
}
